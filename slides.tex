\documentclass[xelatex]{beamer}

\usepackage{xifthen}
\usepackage{multicol}
\usepackage{textcomp}
\usepackage{graphicx}
\usepackage{listings}

\usetheme{Atlassian}
\usecolortheme{whale}
\beamertemplatenavigationsymbolsempty

\title[]{XMPP}
\subtitle{Protocol mechanics and common patterns}
\author[]{%
	Sam Whited\\*%
	{\tiny XSF Editor / HipChat Platform Developer%
}}
\date{2015--12--18}

\makeatletter
\newcommand*{\xml}{\@ifstar{\@xmlStar}{\@xmlNoStar}}
\newcommand*{\@xmlNoStar}[1]{\texttt{\textless #1\textgreater}}
\newcommand*{\@xmlStar}[1]{\texttt{\textless/#1\textgreater}}
\makeatother

\newcommand*{\attr}[2]{%
	#1=\textquotesingle #2\textquotesingle%
}
\newcommand*{\procinst}{\xml{?xml \attr{version}{1.0}?}}
\newcommand*{\xep}[2][]{XEP-#2\ifthenelse{\isempty{#1}}{\relax}{: #1}}
\newcommand*{\stanza}[1]{\xml{#1/}}
\newcommand*{\nonza}[1]{\xml{#1/}}

\begin{document}

	\begin{frame}
		\maketitle
	\end{frame}

	\begin{frame}
		\frametitle{eXtensible Messaging and Presence Protocol}
		\begin{itemize}
			\item XML streams (not documents)
			\item Elements with payloads
				\begin{itemize}
					\item Stanzas: \textit{message, presence, iq}
					\item Nonzas: \textit{auth, compress, \ldots}
				\end{itemize}
			\item Minimal core spec with extensions defined in XEP's
		\end{itemize}
	\end{frame}

	\begin{frame}
	\begin{quotation}
		``Extensions are XMPP's greatest strength, and its greatest weakness.''
		\begin{flushright}
			--- Pretty much everyone
		\end{flushright}
	\end{quotation}
	\end{frame}

	\begin{frame}
		\frametitle{Standards}
		XMPP standardization managed by the IETF. Responsibility for extensions
		delegated to the XSF.
		\begin{itemize}
			\item IETF
			\begin{itemize}
			\item RFC 6120: XMPP Core
			\item RFC 6121: XMPP IM (HipChat)
			\item RFC 7622: XMPP ADDR (JID's)
			\end{itemize}
		\item XSF
			\begin{itemize}
				\item \xep[Multi-User Chat]{0045}
				\item \xep[Stream Management]{0198}
				\item \xep[Entity Versioning]{0366} (yey)
				\item \xep[Message Attaching]{0367} (more yey)
			\item \ldots
			\end{itemize}
		\end{itemize}
	\end{frame}

	\section[]{XMPP Core}
	\frame{\sectionpage}

	\begin{frame}
		\frametitle{Stream's}
		\begin{itemize}
			\item Client first
			\item Two streams (input and output)
			\item Streams are restarted when their state changes (eg. TLS or stream
				compression is started, feature negotiation happens, etc.)
		\end{itemize}
	\end{frame}

	\subsection[]{Stream Initialization and Feature Negotiation}
	\frame{\subsectionpage}

	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace{2em}
				\procinst\\
				\xml{stream:stream \ldots}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace{2em}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\vspace*{8em}
				\xml{starttls \ldots /}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace{2em}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\vspace*{8em}
				\xml{starttls \ldots /}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace{2em}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\vspace*{8em}
				\xml{starttls \ldots /}\\
				\ \\
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace*{2em}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\vspace*{8em}
				\xml{starttls \ldots /}\\
				\ \\
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace*{2em}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\vspace*{8em}
				\xml{starttls \ldots /}\\
				\ \\
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\vspace*{2em}
				\procinst\\
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
				\vspace*{4em}
				\xml{stream:stream \ldots}
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\vspace*{7em}
				\xml{starttls \ldots /}\\
				\vspace*{2em}
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\xml{stream:stream \ldots}\\
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
				\vspace*{4em}
				\xml{stream:stream \ldots}\\
				\xml{stream:features \ldots}\\
				\xml{mechanisms \ldots}\\
				\xml{mechanism}\texttt{SCRAM-SHA-1}\xml*{mechanism}
				\xml*{mechanisms}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\vspace*{6em}
				\xml{starttls \ldots /}\\
				\vspace*{2em}
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}\\
				\vspace*{5em}
				\xml{auth}
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\xml{stream:features}\\
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
				\vspace*{4em}
				\xml{stream:stream \ldots}\\
				\xml{stream:features \ldots}\\
				\xml{mechanisms \ldots}\\
				\xml{mechanism}\texttt{SCRAM-SHA-1}\xml*{mechanism}
				\xml*{mechanisms}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\vspace*{5em}
				\xml{starttls \ldots /}\\
				\vspace*{2em}
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}\\
				\vspace*{5em}
				\xml{auth}\\
				\ldots
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\xml{starttls \ldots}\\
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
				\vspace*{4em}
				\xml{stream:stream \ldots}\\
				\xml{stream:features \ldots}\\
				\xml{mechanisms \ldots}\\
				\xml{mechanism}\texttt{SCRAM-SHA-1}\xml*{mechanism}
				\xml*{mechanisms}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\vspace*{4em}
				\xml{starttls \ldots /}\\
				\vspace*{2em}
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}\\
				\vspace*{5em}
				\xml{auth}\\
				\ldots\\
				\ldots
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\xml{required /}\\
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
				\vspace*{4em}
				\xml{stream:stream \ldots}\\
				\xml{stream:features \ldots}\\
				\xml{mechanisms \ldots}\\
				\xml{mechanism}\texttt{SCRAM-SHA-1}\xml*{mechanism}
				\xml*{mechanisms}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}
	\begin{frame}
		\begin{multicols}{2}
			\begin{flushleft}
				\centerline{Client}
				\vspace*{3em}
				\xml{starttls \ldots /}\\
				\vspace*{2em}
				01000111011001010111010000100000011000100110000101100011\\
				01101011001000000111010001101111001000000111011101101111\\
				\xml{stream:stream \ldots}\\
				\vspace*{5em}
				\xml{auth}\\
				\ldots\\
				\ldots\\
				\ldots
			\end{flushleft}
			\columnbreak
			\begin{flushleft}
				\centerline{Server}
				\xml*{starttls}\\
				\xml*{stream:features}\\
				\vspace*{1em}
				\xml{proceed \ldots /}\\
				\vspace*{4em}
				\xml{stream:stream \ldots}\\
				\xml{stream:features \ldots}\\
				\xml{mechanisms \ldots}\\
				\xml{mechanism}\texttt{SCRAM-SHA-1}\xml*{mechanism}
				\xml*{mechanisms}\\
			\end{flushleft}
		\end{multicols}
	\end{frame}

	\begin{frame}
		\vspace*{\fill}
		\begin{center}
			\includegraphics[width=90mm]{images/deeper.jpg}
		\end{center}
		\vspace*{\fill}
	\end{frame}

	\subsection[]{Inside the stream}
	\frame{\subsectionpage}

	\begin{frame}
		\frametitle{Stanza's}
		The basic primitives of XMPP.
		\begin{itemize}
			\item \stanza{message}
			\item \stanza{iq}
			\item \stanza{presence}
		\end{itemize}

		Generally speaking, these should be the only things sent at the top level of
		an XMPP stream.
	\end{frame}

	\begin{frame}[fragile]
		\frametitle{\stanza{message}}
		Fire and forget
		\begin{lstlisting}[frame=single]
		<message id='262' type='chat'
		 	to='feste@shakespeare.lit/house'>
			<body>What's a drunken man like, fool?</body>
			<request xmlns='urn:xmpp:receipts'/>
			<thread>pNltztLMBQhqakHwcFd</thread>
		</message>
		\end{lstlisting}
	\end{frame}

	\begin{frame}[fragile]
		\frametitle{\stanza{iq}}
		``Information query'', MUST send a response.
		\begin{lstlisting}[frame=single]
		<iq from='capulet.lit'
		 	to='juliet@capulet.lit/balcony'
		 	id='s2c1' type='get'>
		 	<ping xmlns='urn:xmpp:ping'/>
		</iq>

		<iq to='capulet.lit'
		 	from='juliet@capulet.lit/balcony'
		 	id='s2c1' type='result'/>
		\end{lstlisting}
	\end{frame}

	\begin{frame}
		\frametitle{\stanza{presence}}
	\end{frame}
\end{document}
